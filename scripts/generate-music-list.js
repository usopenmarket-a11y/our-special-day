import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Get project root (parent of scripts folder)
const projectRoot = path.resolve(__dirname, '..');
const musicDir = path.join(projectRoot, 'public', 'music');
const outputFile = path.join(projectRoot, 'src', 'lib', 'musicList.ts');

// Read all files from public/music directory
function getMusicFiles() {
  try {
    if (!fs.existsSync(musicDir)) {
      console.log('üìÅ Creating public/music directory...');
      fs.mkdirSync(musicDir, { recursive: true });
      return [];
    }

    const files = fs.readdirSync(musicDir);
    const audioFiles = files
      .filter(file => {
        const ext = file.toLowerCase();
        // Support both MP3 and MP4/M4A formats
        return ext.endsWith('.mp3') || ext.endsWith('.mp4') || ext.endsWith('.m4a');
      })
      .map(file => {
        const filePath = path.join(musicDir, file);
        let detectedFormat = null;
        
        // Try to detect actual file format by reading header
        try {
          const buffer = fs.readFileSync(filePath, { start: 0, end: 20 });
          const header = buffer.toString('hex');
          
          // Check for MP4/M4A format (ftypmp42, ftypM4A, etc.)
          if (header.includes('667479706d703432') || header.includes('667479704d3441')) {
            detectedFormat = 'MP4/M4A';
          }
          // Check for MP3 format (ID3v2 or frame sync)
          else if (header.startsWith('494433') || header.startsWith('fffb') || header.startsWith('fff3')) {
            detectedFormat = 'MP3';
          }
        } catch (err) {
          // If we can't read the file, just use the extension
        }
        
        // Warn if extension doesn't match format
        const ext = file.toLowerCase();
        if (detectedFormat === 'MP4/M4A' && ext.endsWith('.mp3')) {
          console.warn(`‚ö†Ô∏è  Warning: "${file}" has .mp3 extension but is actually MP4/M4A format.`);
          console.warn(`   Consider renaming to .m4a or .mp4 for better browser compatibility.`);
        }
        
        // Use the filename as-is
        // Vite handles special characters in public folder paths
        return `/music/${file}`;
      })
      .sort(); // Sort alphabetically

      return audioFiles;
  } catch (error) {
    console.error('Error reading music directory:', error);
    return [];
  }
}

// Generate TypeScript file with music list
function generateMusicList() {
  const musicFiles = getMusicFiles();
  
  if (musicFiles.length === 0) {
    console.log('‚ö†Ô∏è  No audio files found in public/music/ folder');
    console.log('   Supported formats: .mp3, .mp4, .m4a');
  }
  
  const content = `// Auto-generated file - DO NOT EDIT MANUALLY
// This file is automatically generated by scripts/generate-music-list.js
// Run 'npm run generate-music' to regenerate this file

export const musicFiles: string[] = ${JSON.stringify(musicFiles, null, 2)};

// Export for easy access
export default musicFiles;
`;

  fs.writeFileSync(outputFile, content, 'utf-8');
  
  console.log(`‚úÖ Generated music list with ${musicFiles.length} file(s):`);
  musicFiles.forEach((file, index) => {
    const ext = file.split('.').pop()?.toLowerCase();
    const format = ext === 'mp3' ? 'MP3' : ext === 'mp4' ? 'MP4' : ext === 'm4a' ? 'M4A' : ext?.toUpperCase();
    console.log(`   ${index + 1}. ${file} (${format})`);
  });
  console.log(`\nüìù Saved to: ${outputFile}`);
}

// Run the generator
generateMusicList();
